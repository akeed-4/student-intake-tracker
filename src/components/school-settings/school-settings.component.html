<div class="school-settings-container">
  <h2 class="section-title">{{ 'school-admin.settings.title' | translate }}</h2>
  
  <!-- School Location Section -->
  <p class="section-description">{{ 'school-admin.settings.location' | translate }}</p>
  @if (isMapsConfigured() && !mapAuthFailed()) {
    <div class="form-card">
      
      <!-- Leaflet Geosearch will inject its search bar into the map. This input is a fallback/placeholder. -->
      <div #searchBox style="display: none;"></div>

      <div #mapContainer class="map-container-host"></div>
      
      <p class="marker-instruction">{{ 'school-admin.settings.markerInstruction' | translate }}</p>

      <div class="card-divider"></div>

      <div class="btn-group">
        <button (click)="centerOnMyLocation()"
                [disabled]="isLoadingGeolocation()"
                class="btn-geolocation"
                [class.btn-disabled]="isLoadingGeolocation()">
          @if (isLoadingGeolocation()) {
            <div class="loading-state-content">
              <div class="loading-spinner"></div>
              <span>{{ 'common.processing' | translate }}</span>
            </div>
          } @else {
            <span>{{ 'school-admin.settings.centerButton' | translate }}</span>
          }
        </button>

        <button (click)="saveLocation()"
                [disabled]="isSaveDisabled()"
                class="btn-save-location"
                [class.btn-disabled]="isSaveDisabled()">
          <span>{{ 'school-admin.settings.saveButton' | translate }}</span>
        </button>
      </div>
      @if (locationError()) {
        <p class="error-message">{{ locationError() }}</p>
      }
    </div>
  } @else {
    <div class="maps-not-configured-card">
        <div class="card-header-icon-group">
          <svg xmlns="http://www.w3.org/2000/svg" class="card-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          <h3 class="card-title">{{ 'school-admin.settings.mapsNotConfigured.title' | translate }}</h3>
        </div>
        <p class="card-description">
            {{ 'school-admin.settings.mapsNotConfigured.description' | translate }}
        </p>
    </div>
  }

  <!-- Pickup Zones Section -->
  <div class="card-divider-page"></div>
  <h3 class="section-title">{{ 'school-admin.settings.pickupZones.title' | translate }}</h3>
  <p class="section-description">{{ 'school-admin.settings.pickupZones.description' | translate }}</p>

  <div class="form-and-list-grid">
    <div class="add-zone-form-card">
      <h4 class="form-card-title">{{ 'school-admin.settings.pickupZones.addZone' | translate }}</h4>
      <form (submit)="addZone()" class="form-spacing">
        <div>
          <label class="form-label">{{ 'school-admin.settings.pickupZones.zoneName' | translate }}</label>
          <input type="text" [ngModel]="newZoneName()" (ngModelChange)="newZoneName.set($event)" name="zoneName" required class="form-input">
        </div>
        <div>
          <label class="form-label">{{ 'school-admin.settings.pickupZones.spotCount' | translate }}</label>
          <input type="number" [ngModel]="newZoneSpots()" (ngModelChange)="newZoneSpots.set($event)" name="spotCount" required min="1" class="form-input">
        </div>
        <button type="submit" [disabled]="!isZoneFormValid()" class="btn-primary" [class.btn-disabled]="!isZoneFormValid()">
          {{ 'school-admin.settings.pickupZones.addButton' | translate }}
        </button>
      </form>
    </div>

    <div class="zones-list-wrapper">
      <h4 class="form-card-title">{{ 'school-admin.settings.pickupZones.existing' | translate }}</h4>
       @if (pickupZones().length > 0) {
        <div class="zones-table-container">
          <table class="data-table">
            <tbody>
              @for (zone of pickupZones(); track zone.name) {
                <tr class="table-row">
                  <td class="table-td-primary">{{ 'schoolSupervisor.liveMonitor.zone' | translate }} {{ zone.name }}</td>
                  <td class="table-td">{{ zone.spots }} {{ 'common.spot' | translate }}s</td>
                  <td class="table-td table-td-actions">
                    <button (click)="deleteZone(zone.name)" class="action-button delete-button" [title]="'common.delete' | translate">
                      <svg xmlns="http://www.w3.org/2000/svg" class="icon-small" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                      </svg>
                    </button>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      } @else {
        <div class="no-zones-message">
          <p>{{ 'school-admin.settings.pickupZones.noZones' | translate }}</p>
        </div>
      }
    </div>
  </div>
</div>