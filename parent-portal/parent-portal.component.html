<div class="portal-container">
  <header class="portal-header">
      <button (click)="logout()" title="تسجيل الخروج" class="logout-button">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15m3 0 3-3m0 0-3-3m3 3H9" /></svg>
      </button>
      <div class="title-group">
          <svg class="title-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" /></svg>
          <h1 class="title">بوابة ولي الأمر</h1>
      </div>
       <p class="subtitle">{{ parentViewMode() === 'request' ? 'أبلغ المدرسة عندما تكون في طريقك.' : 'إدارة قائمة الأشخاص المصرح لهم باستلام الطالب.' }}</p>
  </header>

  <main class="portal-main">
  @if (parentViewMode() === 'request') {
    @switch(pickupState.status()) {
        @case('idle') {
            <form (submit)="$event.preventDefault(); notifySchool()" class="pickup-form">
                <fieldset class="form-fieldset">
                    <legend class="form-legend">تفاصيل الطالب</legend>
                    <div class="grid grid-cols-2">
                        <div class="form-group">
                            <label for="studentName" class="form-label">اسم الطالب الكامل</label>
                            <input id="studentName" type="text" [value]="pickupState.studentName()" (input)="onStudentNameInput($event)" placeholder="مثال: جنى عبدالله" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="studentClass" class="form-label">الفصل / الصف</label>
                            <input id="studentClass" type="text" [value]="pickupState.studentClass()" (input)="onStudentClassInput($event)" placeholder="مثال: الصف الثالث (ب)" class="form-input">
                        </div>
                    </div>
                </fieldset>
                <fieldset class="form-fieldset">
                    <legend class="form-legend">تفاصيل الاستلام</legend>
                     <div class="form-group">
                        <label class="form-label">من هو المستلم؟</label>
                         <div class="person-selector-grid">
                            @for(person of authorizedPersons(); track person.id) {
                                <button type="button" (click)="selectedPickupPersonId.set(person.id)"
                                    [class.selected]="selectedPickupPersonId() === person.id"
                                    class="person-card">
                                    <img [src]="person.photo" alt="صورة {{person.name}}" class="person-photo">
                                    <span class="person-name">{{ person.name }}</span>
                                    <span class="person-relation">{{ person.relation }}</span>
                                    @if (selectedPickupPersonId() === person.id) {
                                      <div class="selected-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 0 1 .143 1.052l-8 10.5a.75.75 0 0 1-1.127.075l-4.5-4.5a.75.75 0 0 1 1.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 0 1 1.052-.143Z" clip-rule="evenodd" /></svg>
                                      </div>
                                    }
                                </button>
                            }
                             <button type="button" (click)="parentViewMode.set('manage'); resetPersonForm();" class="add-person-card">
                                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0ZM3 19.235v-.11a6.375 6.375 0 0 1 12.75 0v.109A12.318 12.318 0 0 1 9.374 21c-2.331 0-4.512-.645-6.374-1.766Z" /></svg>
                                 <span>إضافة شخص</span>
                            </button>
                         </div>
                    </div>
                    <div class="grid grid-cols-2">
                        <div class="form-group">
                            <label for="carColor" class="form-label">لون السيارة (اختياري)</label>
                            <input id="carColor" type="text" [value]="pickupState.carColor()" (input)="onCarColorInput($event)" placeholder="مثال: أبيض" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="carPlate" class="form-label">رقم اللوحة (اختياري)</label>
                            <input id="carPlate" type="text" [value]="pickupState.carPlate()" (input)="onCarPlateInput($event)" placeholder="مثال: أ ب ج ١٢٣٤" class="form-input">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="notes" class="form-label">ملاحظات إضافية (اختياري)</label>
                        <textarea id="notes" [value]="pickupState.notes()" (input)="onNotesInput($event)" placeholder="مثال: يرجى تذكيره بإحضار حقيبة الرياضة." rows="2" class="form-textarea"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">الوقت التقديري للوصول</label>
                        <div class="eta-buttons">
                            <button type="button" (click)="setEta(5)" [class.active]="pickupState.eta() === 5" class="eta-button">5 دقائق</button>
                            <button type="button" (click)="setEta(10)" [class.active]="pickupState.eta() === 10" class="eta-button">10 دقائق</button>
                            <button type="button" (click)="setEta(15)" [class.active]="pickupState.eta() === 15" class="eta-button">15 دقيقة</button>
                        </div>
                    </div>
                </fieldset>
                <button type="submit" [disabled]="!pickupState.studentName() || !pickupState.studentClass() || !selectedPickupPersonId()" class="submit-button">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 0 0 5.454-1.31A8.967 8.967 0 0 1 18 9.75V9A6 6 0 0 0 6 9v.75a8.967 8.967 0 0 1-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 0 1-5.714 0m5.714 0a3 3 0 1 1-5.714 0" /></svg>
                    إبلاغ المدرسة
                </button>
            </form>
             <div class="manage-link-container">
                <button (click)="parentViewMode.set('manage')" class="manage-link">أو إدارة قائمة الأشخاص المصرح لهم</button>
            </div>
        }
        @case('notifying') {
            <div class="status-container">
                <div class="spinner"></div>
                <span>جاري التواصل مع المدرسة...</span>
            </div>
        }
        @case('picked_up') {
            <div class="pickup-complete-view">
                <h2 class="student-name">استلام الطالب {{ pickupState.studentName() }}</h2>
                <p class="student-class">الفصل {{ pickupState.studentClass() }}</p>
                <div class="success-message">
                  <strong>نجاح!</strong>
                  <span> تم استلام الطالب {{ pickupState.studentName() }}.</span>
                </div>
                <button (click)="resetAndStartNew()" class="primary-button">
                    بدء طلب استلام جديد
                </button>
            </div>
        }
    }
    @if (pickupState.status() === 'notified' || pickupState.status() === 'teacher_alerted' || pickupState.status() === 'ready') {
        <div class="pickup-status-view">
            <h2 class="student-name">استلام الطالب {{ pickupState.studentName() }}</h2>
            <p class="student-class">الفصل {{ pickupState.studentClass() }}</p>
            <div class="qr-code-container">
                <p class="qr-code-instruction">أظهر هذا الرمز لحارس المدرسة للتحقق</p>
                <div id="qrcode" class="qr-code"></div>
                <div>
                    <p class="code-instruction">أو استخدم الرمز الرقمي:</p>
                    <p class="pickup-code">{{ pickupState.pickupCode() }}</p>
                </div>
            </div>
             <div class="share-container">
              <button (click)="sharePickupDetails()" class="share-button">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M7.217 10.907a2.25 2.25 0 1 0 0 4.186m0-4.186a2.25 2.25 0 1 1 0 4.186m0-4.186 9.566-5.314m-9.566 5.314 9.566 5.314m0 0a2.25 2.25 0 1 0 0 4.186 2.25 2.25 0 0 0 0-4.186m-9.566-5.314a2.25 2.25 0 1 0 0-4.186 2.25 2.25 0 0 0 0 4.186" /></svg>
                  مشاركة تفاصيل الاستلام
              </button>
              <div class="share-status-message-container">
                @if (shareStatusMessage()) {
                    <p class="share-status-message">{{ shareStatusMessage() }}</p>
                }
              </div>
            </div>
            @if (pickupState.geminiMessage()) {
                <blockquote class="gemini-message">
                    {{ pickupState.geminiMessage() }}
                </blockquote>
            }
            <ol class="status-stepper">
                <li class="step" [class.completed]="pickupState.status() === 'notified' || pickupState.status() === 'teacher_alerted' || pickupState.status() === 'ready' || pickupState.status() === 'picked_up'">
                    <div class="step-content">
                        <span class="step-icon-wrapper">
                            <svg class="step-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm3.857-9.809a.75.75 0 0 0-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 1 0-1.06 1.061l2.5 2.5a.75.75 0 0 0 1.137-.089l4-5.5Z" clip-rule="evenodd" /></svg>
                        </span>
                        <span class="step-label">تم الإبلاغ</span>
                    </div>
                </li>
                <li class="step" [class.completed]="pickupState.status() === 'teacher_alerted' || pickupState.status() === 'ready' || pickupState.status() === 'picked_up'">
                    <div class="step-content">
                        <span class="step-icon-wrapper">
                           <svg class="step-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm3.857-9.809a.75.75 0 0 0-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 1 0-1.06 1.061l2.5 2.5a.75.75 0 0 0 1.137-.089l4-5.5Z" clip-rule="evenodd" /></svg>
                        </span>
                        <span class="step-label">تم إبلاغ المعلم</span>
                    </div>
                </li>
                <li class="step" [class.completed]="pickupState.status() === 'ready' || pickupState.status() === 'picked_up'">
                    <div class="step-content">
                        <span class="step-icon-wrapper">
                            <svg class="step-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm3.857-9.809a.75.75 0 0 0-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 1 0-1.06 1.061l2.5 2.5a.75.75 0 0 0 1.137-.089l4-5.5Z" clip-rule="evenodd" /></svg>
                        </span>
                        <span class="step-label">جاهز للاستلام</span>
                    </div>
                </li>
                <li class="step" [class.completed]="pickupState.status() === 'picked_up'">
                    <div class="step-content">
                        <span class="step-icon-wrapper">
                            <svg class="step-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm3.857-9.809a.75.75 0 0 0-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 1 0-1.06 1.061l2.5 2.5a.75.75 0 0 0 1.137-.089l4-5.5Z" clip-rule="evenodd" /></svg>
                        </span>
                        <span class="step-label">تم الاستلام</span>
                    </div>
                </li>
            </ol>
        </div>
    }
    @if (pickupState.error()) {
        <p class="error-message">{{ pickupState.error() }}</p>
    }
  } @else { <!-- parentViewMode() === 'manage' -->
    <div class="manage-view">
      <header class="manage-view-header">
        <h2 class="manage-title">الأشخاص المصرح لهم</h2>
        <button (click)="parentViewMode.set('request')" class="back-link">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 15 3 9m0 0 6-6M3 9h12a6 6 0 0 1 0 12h-3" /></svg>
            العودة لطلب الاستلام
        </button>
      </header>

      <div class="manage-grid">
          <!-- Add/Edit Person Form -->
          <div class="person-form-container">
              <h3 class="person-form-title">{{ editingPersonId() ? 'تعديل بيانات الشخص' : 'إضافة شخص جديد' }}</h3>
               @if (saveStatusMessage()) {
                <div class="save-success-message">{{ saveStatusMessage() }}</div>
               }
              <form (submit)="$event.preventDefault(); saveAuthorizedPerson()" class="person-form">
                  <div class="form-group">
                      <label class="form-label">صورة الشخص</label>
                      <div class="photo-input-group">
                          @if(personFormPhoto()){
                              <img [src]="personFormPhoto()" class="photo-preview">
                          } @else {
                              <div class="photo-placeholder">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" /></svg>
                              </div>
                          }
                          <input type="file" (change)="onPhotoSelected($event)" accept="image/*" class="photo-input"/>
                      </div>
                  </div>
                  <div class="form-group">
                      <label for="personName" class="form-label">الاسم الكامل</label>
                      <input id="personName" type="text" [value]="personFormName()" (input)="onPersonFormNameInput($event)" placeholder="مثال: أحمد محمد" class="form-input">
                  </div>
                  <div class="form-group">
                      <label for="personRelation" class="form-label">صلة القرابة</label>
                      <input id="personRelation" type="text" [value]="personFormRelation()" (input)="onPersonFormRelationInput($event)" placeholder="مثال: الجد" class="form-input">
                  </div>
                   <div class="form-group">
                      <label for="personIdNumber" class="form-label">رقم الهوية / الإقامة</label>
                      <input id="personIdNumber" type="text" [value]="personFormIdNumber()" (input)="onPersonFormIdNumberInput($event)" placeholder="10xxxxxxxx" class="form-input">
                  </div>
                  <div class="form-actions">
                    <button type="submit" [disabled]="!personFormName() || !personFormRelation() || !personFormIdNumber() || !personFormPhoto()" class="submit-button">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                        {{ editingPersonId() ? 'تحديث' : 'حفظ' }}
                    </button>
                     @if(editingPersonId()){
                        <button type="button" (click)="resetPersonForm()" class="cancel-button">إلغاء التعديل</button>
                     }
                  </div>
              </form>
          </div>

          <!-- List of Persons -->
           <div class="person-list">
              @for(person of authorizedPersons(); track person.id) {
                <div class="person-list-item">
                  <div class="person-details">
                    <img [src]="person.photo" alt="صورة {{person.name}}" class="person-list-photo">
                    <div>
                      <p class="person-list-name">{{ person.name }}</p>
                      <p class="person-list-relation">{{ person.relation }}</p>
                      <p class="person-list-id">الهوية: {{ person.idNumber }}</p>
                    </div>
                  </div>
                  <div class="person-actions">
                    <button (click)="editPerson(person)" title="تعديل" class="action-button">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg>
                    </button>
                    <button (click)="requestDeletePerson(person.id)" title="حذف" class="action-button delete-button">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.067-2.09 1.02-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg>
                    </button>
                  </div>
                </div>
              }
              @if (!authorizedPersons().length) {
                <p class="empty-list-message">لا يوجد أشخاص مضافون حالياً. ابدأ بإضافة شخص جديد.</p>
              }
          </div>
      </div>
    </div>
     @if (personToDelete()) {
      <div class="confirmation-dialog-backdrop">
        <div class="confirmation-dialog-box">
          <h3 class="dialog-title">تأكيد الحذف</h3>
          <p>هل أنت متأكد من رغبتك في حذف <strong>{{ personToDelete()?.name }}</strong> من قائمة الأشخاص المصرح لهم؟</p>
          <div class="dialog-actions">
            <button (click)="cancelDelete()" class="dialog-cancel-button">إلغاء</button>
            <button (click)="confirmDelete()" class="dialog-confirm-button">نعم، قم بالحذف</button>
          </div>
        </div>
      </div>
    }
  }
  </main>
</div>